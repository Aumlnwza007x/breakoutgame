<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcade Hub - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏°‡∏™‡∏∏‡∏î‡∏°‡∏±‡∏ô‡∏™‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            margin: 0;
            overflow-x: hidden;
        }
        .glass-morphism {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.5);
        }
        .hex-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .hex-cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .hex-cell:hover { background: rgba(59, 130, 246, 0.2); }
        .unit { font-size: 1.5rem; transition: all 0.3s ease; }
        .battle-log { height: 100px; overflow-y: auto; font-size: 0.75rem; color: #94a3b8; }
        canvas { background: #000; display: block; border-radius: 0.5rem; touch-action: none; max-width: 100%; height: auto; }
    </style>
</head>
<body>

    <div id="app">
        <!-- Navigation -->
        <nav class="p-4 glass-morphism sticky top-0 z-50 flex justify-between items-center">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 cursor-pointer" onclick="showView('home')">ARCADE HUB</h1>
            <div class="flex items-center space-x-4">
                <div class="text-xs font-mono text-blue-400">User ID: <span id="displayUserId">Offline</span></div>
                <div class="text-sm font-mono text-yellow-400">Coins: <span id="globalCoins">0</span></div>
            </div>
        </nav>

        <!-- VIEW: Home -->
        <div id="homeView" class="container mx-auto p-6">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <!-- Game 1: Breakout -->
                <div class="game-card glass-morphism rounded-2xl overflow-hidden cursor-pointer group" onclick="showView('breakout')">
                    <div class="h-40 bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center">
                        <span class="text-5xl group-hover:scale-110 transition">üéæ</span>
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-bold">Breakout Boss</h3>
                        <p class="text-sm text-gray-400">‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏¢‡∏ö‡∏ö‡∏≠‡∏™</p>
                    </div>
                </div>

                <!-- Game 2: Auto Battler Online -->
                <div class="game-card glass-morphism rounded-2xl overflow-hidden cursor-pointer group" onclick="showView('tft')">
                    <div class="h-40 bg-gradient-to-br from-purple-600 to-indigo-900 flex items-center justify-center relative">
                        <span class="text-5xl group-hover:scale-110 transition">‚öîÔ∏è</span>
                        <div class="absolute top-2 right-2 bg-red-500 text-[10px] px-2 py-0.5 rounded-full font-bold">ONLINE</div>
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-bold">Arcade Auto Battler</h3>
                        <p class="text-sm text-gray-400">‡∏à‡∏±‡∏î‡∏ó‡∏±‡∏û‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ö‡∏ö Real-time</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: Breakout Game -->
        <div id="breakoutView" class="hidden container mx-auto p-4 flex flex-col items-center">
             <div class="w-full max-w-4xl flex justify-between items-center mb-4">
                <button onclick="showView('home')" class="text-gray-400 hover:text-white">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
                <div id="bStats" class="text-sm font-mono"><span id="bScore">Score: 0</span> | Lives: <span id="bLives">3</span></div>
             </div>
             <canvas id="breakoutCanvas" width="800" height="600" class="border border-gray-700 shadow-2xl rounded-lg"></canvas>
        </div>

        <!-- VIEW: TFT Online Game -->
        <div id="tftView" class="hidden container mx-auto p-4 flex flex-col items-center max-w-5xl">
            <div id="tftLobby" class="w-full max-w-md bg-gray-800 p-8 rounded-2xl border border-gray-700 text-center">
                <h2 class="text-2xl font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
                <p class="text-sm text-gray-400 mb-6">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô</p>
                <button id="findMatchBtn" class="w-full bg-purple-600 py-3 rounded-xl font-bold hover:bg-purple-700 transition">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</button>
                <div id="matchingStatus" class="mt-4 text-sm text-yellow-400 hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ...</div>
                <button onclick="showView('home')" class="mt-6 text-gray-500 text-sm underline block w-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>

            <div id="tftBoard" class="hidden w-full grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Status & Shop -->
                <div class="lg:col-span-1 space-y-4">
                    <div class="glass-morphism p-4 rounded-xl">
                        <h3 class="font-bold text-blue-400 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
                        <div class="flex justify-between text-sm"><span>HP:</span><span id="playerHp" class="text-green-400">100</span></div>
                        <div class="flex justify-between text-sm"><span>‡∏ó‡∏≠‡∏á:</span><span id="playerGold" class="text-yellow-400">10</span></div>
                        <div class="flex justify-between text-sm mt-2"><span>‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á HP:</span><span id="enemyHp" class="text-red-400">100</span></div>
                    </div>
                    <div class="glass-morphism p-4 rounded-xl">
                        <h3 class="font-bold text-purple-400 mb-2">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <div id="shopUnits" class="grid grid-cols-1 gap-2"></div>
                        <button id="rerollBtn" class="w-full mt-3 bg-gray-700 py-1 rounded text-xs hover:bg-gray-600">‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (2 ‡∏ó‡∏≠‡∏á)</button>
                    </div>
                </div>

                <!-- Battleground -->
                <div class="lg:col-span-3 space-y-4">
                    <div class="flex justify-between items-center">
                        <div id="gamePhase" class="text-xl font-bold text-yellow-500">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£ (20s)</div>
                    </div>
                    <div class="bg-gray-900 border-2 border-gray-800 p-4 rounded-2xl">
                        <div id="enemyBoard" class="hex-grid mb-8 opacity-60"></div>
                        <div class="border-t border-dashed border-gray-700 my-4"></div>
                        <div id="playerBoard" class="hex-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        let db, auth, appId;
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'arcade-hub-v2';
        } catch (e) {
            console.error("Firebase config missing or invalid.");
        }

        let currentUser = null;
        let currentGameRoom = null;
        let isPlayer1 = false;
        let myGold = 10;
        let shopData = [];

        // --- CORE LOGIC ---
        window.showView = (view) => {
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('breakoutView').classList.add('hidden');
            document.getElementById('tftView').classList.add('hidden');
            document.getElementById(view + 'View').classList.remove('hidden');
            
            if (view === 'breakout') startBreakout();
            else stopBreakout();

            if (view === 'tft') {
                // Reset lobby if needed
                document.getElementById('tftLobby').classList.remove('hidden');
                document.getElementById('tftBoard').classList.add('hidden');
                document.getElementById('matchingStatus').classList.add('hidden');
            }
        };

        // --- AUTH & INITIALIZATION ---
        if (auth) {
            signInAnonymously(auth).then(() => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('displayUserId').innerText = user.uid.substring(0, 8);
                        loadCoins();
                    }
                });
            });
        }

        let coins = parseInt(localStorage.getItem('arcade_coins')) || 0;
        const loadCoins = () => { document.getElementById('globalCoins').innerText = coins; };

        // --- BREAKOUT GAME ENGINE ---
        const bCanvas = document.getElementById('breakoutCanvas');
        const bCtx = bCanvas.getContext('2d');
        let bAnimId, bBall, bPaddle, bBricks, bScore, bLives;

        function startBreakout() {
            bScore = 0; bLives = 3;
            bPaddle = { x: bCanvas.width / 2 - 70, w: 140, h: 15 };
            bBall = { x: bCanvas.width / 2, y: bCanvas.height - 50, dx: 4, dy: -4, r: 8 };
            initBricks();
            updateBreakoutUI();
            bLoop();
        }

        function initBricks() {
            bBricks = [];
            for(let c=0; c<8; c++) {
                bBricks[c] = [];
                for(let r=0; r<4; r++) bBricks[c][r] = { x: 0, y: 0, status: 1 };
            }
        }

        function stopBreakout() { cancelAnimationFrame(bAnimId); }

        function bLoop() {
            bCtx.clearRect(0, 0, bCanvas.width, bCanvas.height);
            // Draw Paddle
            bCtx.fillStyle = "#3b82f6";
            bCtx.fillRect(bPaddle.x, bCanvas.height - 30, bPaddle.w, bPaddle.h);
            // Draw Ball
            bCtx.beginPath(); bCtx.arc(bBall.x, bBall.y, bBall.r, 0, Math.PI*2); bCtx.fillStyle = "#fff"; bCtx.fill(); bCtx.closePath();
            // Collision & Movement
            if(bBall.x + bBall.dx > bCanvas.width - bBall.r || bBall.x + bBall.dx < bBall.r) bBall.dx = -bBall.dx;
            if(bBall.y + bBall.dy < bBall.r) bBall.dy = -bBall.dy;
            else if(bBall.y + bBall.dy > bCanvas.height - 30) {
                if(bBall.x > bPaddle.x && bBall.x < bPaddle.x + bPaddle.w) bBall.dy = -bBall.dy;
                else {
                    bLives--; updateBreakoutUI();
                    if(!bLives) { alert("Game Over"); showView('home'); return; }
                    bBall.x = bCanvas.width/2; bBall.y = bCanvas.height-50; bBall.dy = -4;
                }
            }
            // Bricks
            bBricks.forEach((col, c) => col.forEach((b, r) => {
                if(b.status === 1) {
                    let bx = c * 90 + 45, by = r * 30 + 60;
                    bCtx.fillStyle = "#ef4444"; bCtx.fillRect(bx, by, 80, 20);
                    if(bBall.x > bx && bBall.x < bx + 80 && bBall.y > by && bBall.y < by + 20) {
                        bBall.dy = -bBall.dy; b.status = 0; bScore += 10; updateBreakoutUI();
                    }
                }
            }));

            bBall.x += bBall.dx; bBall.y += bBall.dy;
            bAnimId = requestAnimationFrame(bLoop);
        }

        function updateBreakoutUI() {
            document.getElementById('bScore').innerText = "Score: " + bScore;
            document.getElementById('bLives').innerText = bLives;
        }

        bCanvas.addEventListener('mousemove', (e) => {
            const rect = bCanvas.getBoundingClientRect();
            bPaddle.x = (e.clientX - rect.left) * (bCanvas.width / rect.width) - bPaddle.w/2;
        });

        // --- TFT ONLINE LOGIC ---
        const UNIT_TYPES = [
            { id: 'knight', emoji: 'üõ°Ô∏è', hp: 100, cost: 1, name: '‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô' },
            { id: 'mage', emoji: 'üî•', hp: 60, cost: 2, name: '‡∏ô‡∏±‡∏Å‡πÄ‡∏ß‡∏ó‡∏¢‡πå' },
            { id: 'archer', emoji: 'üèπ', hp: 70, cost: 1, name: '‡∏ô‡∏±‡∏Å‡∏ò‡∏ô‡∏π' },
            { id: 'assassin', emoji: 'üó°Ô∏è', hp: 50, cost: 3, name: '‡∏ô‡∏±‡∏Å‡∏Ü‡πà‡∏≤' }
        ];

        document.getElementById('findMatchBtn').onclick = async () => {
            if (!db || !currentUser) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase..."); return; }
            document.getElementById('matchingStatus').classList.remove('hidden');
            const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'tft_rooms');
            const q = query(roomsRef, where('status', '==', 'waiting'));
            const snap = await getDocs(q);

            if (snap.empty) {
                const roomId = currentUser.uid;
                currentGameRoom = roomId; isPlayer1 = true;
                await setDoc(doc(roomsRef, roomId), {
                    player1: { id: currentUser.uid, hp: 100, board: Array(14).fill(null) },
                    status: 'waiting', phase: 'prep', timer: 20
                });
                listenToRoom(roomId);
            } else {
                currentGameRoom = snap.docs[0].id; isPlayer1 = false;
                await updateDoc(doc(roomsRef, currentGameRoom), {
                    player2: { id: currentUser.uid, hp: 100, board: Array(14).fill(null) },
                    status: 'playing'
                });
                listenToRoom(currentGameRoom);
            }
        };

        function listenToRoom(roomId) {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'tft_rooms', roomId), (snap) => {
                const data = snap.data();
                if (data && data.status === 'playing') {
                    document.getElementById('tftLobby').classList.add('hidden');
                    document.getElementById('tftBoard').classList.remove('hidden');
                    renderTFT(data);
                    if(shopData.length === 0) refreshShop();
                }
            });
        }

        function refreshShop() {
            shopData = Array(3).fill(null).map(() => UNIT_TYPES[Math.floor(Math.random() * UNIT_TYPES.length)]);
            const shopEl = document.getElementById('shopUnits');
            shopEl.innerHTML = '';
            shopData.forEach((unit, idx) => {
                const btn = document.createElement('button');
                btn.className = 'flex justify-between items-center p-2 bg-gray-700 rounded hover:bg-gray-600 transition text-xs';
                btn.innerHTML = `<span>${unit.emoji} ${unit.name}</span> <span class="text-yellow-400">${unit.cost}G</span>`;
                btn.onclick = () => buyUnit(idx);
                shopEl.appendChild(btn);
            });
        }

        async function buyUnit(idx) {
            const unit = shopData[idx];
            if (myGold >= unit.cost) {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'tft_rooms', currentGameRoom);
                const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'tft_rooms'))); // Simplified for context
                
                // Get current local board state and find empty slot
                const boardEl = document.getElementById('playerBoard');
                const emptySlot = Array.from(boardEl.children).findIndex(c => !c.innerHTML);
                
                if (emptySlot !== -1) {
                    myGold -= unit.cost;
                    document.getElementById('playerGold').innerText = myGold;
                    shopData.splice(idx, 1);
                    refreshShop();
                    
                    // Update Firebase Board
                    const roomDoc = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'tft_rooms')));
                    // In a real app, you'd fetch the latest doc, update its board array locally, then push.
                    // Here we'll simulate the update for the UI:
                    const field = isPlayer1 ? 'player1.board' : 'player2.board';
                    // Fetch current board from UI to update
                    const currentBoard = Array.from(boardEl.children).map(c => c.innerHTML ? {emoji: c.querySelector('.unit').innerText} : null);
                    currentBoard[emptySlot] = unit;
                    await updateDoc(roomRef, { [field]: currentBoard });
                }
            }
        }

        document.getElementById('rerollBtn').onclick = () => {
            if (myGold >= 2) {
                myGold -= 2;
                document.getElementById('playerGold').innerText = myGold;
                refreshShop();
            }
        };

        function renderTFT(data) {
            const myData = isPlayer1 ? data.player1 : data.player2;
            const enemyData = isPlayer1 ? data.player2 : data.player1;

            document.getElementById('playerHp').innerText = myData.hp;
            document.getElementById('enemyHp').innerText = enemyData ? enemyData.hp : '...';
            
            renderHexBoard('playerBoard', myData.board);
            renderHexBoard('enemyBoard', enemyData ? enemyData.board : Array(14).fill(null));
        }

        function renderHexBoard(id, board) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            board.forEach(u => {
                const cell = document.createElement('div');
                cell.className = 'hex-cell';
                if(u) cell.innerHTML = `<span class="unit">${u.emoji}</span>`;
                el.appendChild(cell);
            });
        }

        // Initialize
        showView('home');
    </script>
</body>
</html>
