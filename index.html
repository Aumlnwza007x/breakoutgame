import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, deleteDoc, updateDoc, arrayUnion } from 'firebase/firestore';
import { Trophy, Users, Sword, Shield, Coins, ArrowLeft, Play, LayoutGrid } from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'aum-hub-v1';

// --- Game Data Definitions ---
const CHAMPIONS_POOL = [
  { id: 'knight', name: 'Knight', cost: 1, hp: 600, atk: 50, color: '#3b82f6', icon: 'üõ°Ô∏è' },
  { id: 'archer', name: 'Archer', cost: 1, hp: 400, atk: 70, color: '#10b981', icon: 'üèπ' },
  { id: 'mage', name: 'Mage', cost: 2, hp: 350, atk: 90, color: '#8b5cf6', icon: 'ü™Ñ' },
  { id: 'warrior', name: 'Warrior', cost: 2, hp: 800, atk: 60, color: '#f59e0b', icon: '‚öîÔ∏è' },
  { id: 'dragon', name: 'Dragon', cost: 3, hp: 1200, atk: 120, color: '#ef4444', icon: 'üêâ' },
  { id: 'assassin', name: 'Assassin', cost: 3, hp: 500, atk: 150, color: '#ec4899', icon: 'üî™' },
];

export default function App() {
  const [view, setView] = useState('lobby');
  const [user, setUser] = useState(null);
  const [roomData, setRoomData] = useState(null);
  const [gold, setGold] = useState(10);
  const [myBench, setMyBench] = useState([]);
  const [myBoard, setMyBoard] = useState([]);
  const [shop, setShop] = useState([]);

  // 1. Auth & Initial Load
  useEffect(() => {
    const login = async () => {
      await signInAnonymously(auth);
    };
    login();
    return onAuthStateChanged(auth, (u) => {
      if (u) {
        setUser(u);
        refreshShop();
      }
    });
  }, []);

  // 2. Online Listener (Listen to Room updates)
  useEffect(() => {
    if (!user || !roomData?.id) return;

    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomData.id);
    const unsubscribe = onSnapshot(roomRef, (doc) => {
      if (doc.exists()) {
        setRoomData({ id: doc.id, ...doc.data() });
      }
    }, (err) => console.error("Firestore Error:", err));

    return () => unsubscribe();
  }, [user, roomData?.id]);

  // --- TFT Game Logic ---
  const refreshShop = () => {
    const newShop = Array.from({ length: 5 }, () => 
      CHAMPIONS_POOL[Math.floor(Math.random() * CHAMPIONS_POOL.length)]
    );
    setShop(newShop);
  };

  const buyChampion = (champ, index) => {
    if (gold >= champ.cost && myBench.length < 8) {
      setGold(prev => prev - champ.cost);
      setMyBench([...myBench, { ...champ, instanceId: Math.random().toString(36).substr(2, 9) }]);
      const newShop = [...shop];
      newShop[index] = null;
      setShop(newShop);
    }
  };

  const joinGame = async () => {
    if (!user) return;
    const roomId = "online-lobby-01"; // Simplification for demo: everyone joins one room
    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
    
    const initialPlayerState = {
      uid: user.uid,
      name: `Player ${user.uid.substr(0, 4)}`,
      hp: 100,
      board: []
    };

    await setDoc(roomRef, {
      players: { [user.uid]: initialPlayerState },
      lastUpdated: Date.now()
    }, { merge: true });

    setRoomData({ id: roomId });
    setView('tft');
  };

  const updateOnlineBoard = async (newBoard) => {
    if (!user || !roomData?.id) return;
    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomData.id);
    await updateDoc(roomRef, {
      [`players.${user.uid}.board`]: newBoard,
      lastUpdated: Date.now()
    });
  };

  const placeOnBoard = (champ, index) => {
    const newBoard = [...myBoard, champ];
    setMyBoard(newBoard);
    setMyBench(myBench.filter((_, i) => i !== index));
    updateOnlineBoard(newBoard);
  };

  // --- UI Components ---
  if (view === 'lobby') {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex flex-col items-center justify-center p-6 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-slate-950 to-slate-950">
        <div className="text-center mb-12">
          <h1 className="text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-blue-400 via-purple-400 to-pink-500">
            AUM HUB
          </h1>
          <p className="text-slate-400 mt-2 tracking-[0.3em] uppercase text-sm">Next-Gen Gaming Hub</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
          <button onClick={() => setView('breakout')} className="group relative overflow-hidden bg-slate-900/50 border border-slate-800 p-8 rounded-3xl transition-all hover:border-blue-500 hover:shadow-[0_0_30px_-10px_rgba(59,130,246,0.5)]">
            <div className="absolute top-0 left-0 w-2 h-full bg-blue-500" />
            <LayoutGrid className="w-12 h-12 text-blue-400 mb-4 group-hover:scale-110 transition-transform" />
            <h2 className="text-2xl font-bold text-left">Breakout Boss</h2>
            <p className="text-slate-400 text-left text-sm mt-2">‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ù‡πà‡∏≤‡∏î‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏™‡∏™‡∏∏‡∏î‡πÇ‡∏´‡∏î</p>
          </button>

          <button onClick={joinGame} className="group relative overflow-hidden bg-slate-900/50 border border-slate-800 p-8 rounded-3xl transition-all hover:border-purple-500 hover:shadow-[0_0_30px_-10px_rgba(168,85,247,0.5)]">
            <div className="absolute top-0 left-0 w-2 h-full bg-purple-500" />
            <Users className="w-12 h-12 text-purple-400 mb-4 group-hover:scale-110 transition-transform" />
            <h2 className="text-2xl font-bold text-left">TFT Online Arena</h2>
            <p className="text-slate-400 text-left text-sm mt-2">‡∏õ‡∏£‡∏∞‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå 1v1 ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô</p>
          </button>
        </div>
      </div>
    );
  }

  if (view === 'tft') {
    const otherPlayers = roomData?.players ? Object.values(roomData.players).filter(p => p.uid !== user?.uid) : [];

    return (
      <div className="min-h-screen bg-slate-950 text-white flex flex-col p-4 font-sans">
        {/* Header */}
        <div className="flex justify-between items-center mb-4">
          <button onClick={() => setView('lobby')} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700">
            <ArrowLeft className="w-6 h-6" />
          </button>
          <div className="flex gap-4">
            <div className="bg-slate-800 px-4 py-1 rounded-full border border-yellow-500/50 flex items-center gap-2">
              <Coins className="w-4 h-4 text-yellow-500" />
              <span className="font-bold text-yellow-500">{gold}</span>
            </div>
          </div>
        </div>

        <div className="flex-1 grid grid-cols-1 lg:grid-cols-4 gap-4 overflow-hidden">
          {/* Main Board Area */}
          <div className="lg:col-span-3 flex flex-col gap-4">
            {/* Enemy Display (Online) */}
            <div className="bg-slate-900/50 p-4 rounded-2xl border border-red-500/20">
              <div className="text-[10px] text-red-400 mb-2 uppercase font-bold tracking-widest flex items-center gap-2">
                <Sword className="w-3 h-3" /> Enemy Board (Real-time)
              </div>
              <div className="grid grid-cols-6 gap-2 h-32">
                {otherPlayers[0]?.board?.map((c, i) => (
                  <div key={i} className="bg-slate-800 rounded-lg flex items-center justify-center text-2xl border border-slate-700">
                    {c.icon}
                  </div>
                ))}
                {!otherPlayers.length && <div className="col-span-6 flex items-center justify-center text-slate-600 text-sm italic">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...</div>}
              </div>
            </div>

            {/* Player Board */}
            <div className="flex-1 bg-slate-900/80 p-6 rounded-3xl border border-blue-500/20 relative">
               <div className="text-[10px] text-blue-400 mb-2 uppercase font-bold tracking-widest flex items-center gap-2">
                <Shield className="w-3 h-3" /> Your Board
              </div>
              <div className="grid grid-cols-6 gap-4 h-64 content-center">
                {myBoard.map((c, i) => (
                  <div key={i} className="relative group aspect-square bg-slate-800 rounded-xl flex items-center justify-center text-4xl shadow-xl border-b-4" style={{borderColor: c.color}}>
                    {c.icon}
                    <div className="absolute -top-2 -right-2 bg-blue-500 text-[8px] px-1 rounded uppercase font-bold">{c.name}</div>
                  </div>
                ))}
                {Array.from({ length: 12 - myBoard.length }).map((_, i) => (
                  <div key={i} className="aspect-square border-2 border-dashed border-slate-800 rounded-xl" />
                ))}
              </div>
            </div>

            {/* Bench */}
            <div className="bg-slate-900/50 p-4 rounded-2xl border border-slate-800">
              <div className="text-[10px] text-slate-500 mb-2 uppercase font-bold tracking-widest">Bench (‡∏™‡∏≥‡∏£‡∏≠‡∏á)</div>
              <div className="flex gap-2">
                {myBench.map((c, i) => (
                  <button key={i} onClick={() => placeOnBoard(c, i)} className="w-16 h-16 bg-slate-800 rounded-lg flex items-center justify-center text-2xl hover:bg-slate-700 transition-colors border-b-2" style={{borderColor: c.color}}>
                    {c.icon}
                  </button>
                ))}
                {Array.from({ length: 8 - myBench.length }).map((_, i) => (
                  <div key={i} className="w-16 h-16 bg-slate-950/50 border border-slate-800 rounded-lg" />
                ))}
              </div>
            </div>
          </div>

          {/* Shop & Side Info */}
          <div className="lg:col-span-1 flex flex-col gap-4">
             <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800">
                <h3 className="font-bold mb-4 flex items-center gap-2">
                  <Coins className="w-4 h-4 text-yellow-500" /> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
                </h3>
                <div className="flex flex-col gap-2">
                  {shop.map((c, i) => c ? (
                    <button 
                      key={i} 
                      onClick={() => buyChampion(c, i)}
                      disabled={gold < c.cost}
                      className={`p-3 rounded-xl border flex items-center justify-between transition-all ${gold >= c.cost ? 'bg-slate-800 border-slate-700 hover:border-yellow-500' : 'opacity-50 bg-slate-900 border-transparent cursor-not-allowed'}`}
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">{c.icon}</span>
                        <div className="text-left">
                          <p className="text-xs font-bold">{c.name}</p>
                          <p className="text-[10px] text-slate-400">{c.cost} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                      </div>
                      <div className="text-yellow-500 font-bold">${c.cost}</div>
                    </button>
                  ) : (
                    <div key={i} className="p-3 bg-slate-950 rounded-xl border border-dashed border-slate-800 text-[10px] text-center text-slate-700">SOLD OUT</div>
                  ))}
                </div>
                <button onClick={() => { if(gold>=2){ setGold(g=>g-2); refreshShop(); }}} className="w-full mt-4 py-2 bg-blue-600 rounded-lg font-bold text-xs hover:bg-blue-500 transition-colors">
                  ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (2 ‡∏ö‡∏≤‡∏ó)
                </button>
             </div>

             <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex-1">
                <h3 className="font-bold mb-4 text-xs uppercase text-slate-500 flex items-center gap-2">
                  <Users className="w-3 h-3" /> ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á
                </h3>
                <div className="space-y-2">
                  {otherPlayers.map((p, i) => (
                    <div key={i} className="flex items-center justify-between bg-slate-950 p-2 rounded-lg border border-slate-800">
                      <span className="text-xs">{p.name}</span>
                      <div className="w-20 bg-slate-800 h-2 rounded-full overflow-hidden">
                        <div className="bg-green-500 h-full" style={{width: `${p.hp}%`}} />
                      </div>
                    </div>
                  ))}
                </div>
             </div>
          </div>
        </div>
      </div>
    );
  }

  // --- Breakout View (Minimal placeholder for integration) ---
  if (view === 'breakout') {
    return (
      <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center">
        <button onClick={() => setView('lobby')} className="absolute top-4 left-4 p-2 bg-slate-800 rounded-full"><ArrowLeft /></button>
        <h2 className="text-2xl font-bold mb-4 text-blue-400">Breakout Boss Engine</h2>
        <div className="bg-slate-900 p-12 rounded-3xl border border-slate-800 text-slate-500 italic">
          [‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏° Breakout ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà]
        </div>
      </div>
    );
  }

  return null;
}
