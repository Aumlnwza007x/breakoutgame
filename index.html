<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Breakout Game - Boss Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            overscroll-behavior-y: contain;
        }
        canvas {
            background: #000;
            display: block;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            touch-action: none;
        }
    </style>
</head>
<body class="p-2">
    <div class="flex flex-col items-center space-y-2 max-w-4xl w-full">
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-red-500">Breakout: Boss Evolution</h1>
            <p id="levelIndicator" class="text-xs md:text-sm text-gray-400 font-mono uppercase">Level 1</p>
        </div>
        
        <div class="relative w-full flex justify-center">
            <canvas id="gameCanvas" width="800" height="600" class="w-full h-auto max-w-3xl border border-gray-700"></canvas>

            <!-- UI Overlay: Start Modal -->
            <div id="startModal" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-80 rounded-lg z-10 p-4">
                <div class="bg-gray-800 p-6 md:p-8 rounded-lg shadow-2xl text-center w-full max-w-sm border border-gray-600">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-white">เตรียมตัวให้พร้อม</h2>
                    <input type="text" id="nameInput" placeholder="ใส่ชื่อของคุณ" class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 mb-4 text-center">
                    
                    <select id="difficultySelect" class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 mb-6 cursor-pointer">
                        <option value="easy">ง่าย (Easy)</option>
                        <option value="medium" selected>ปานกลาง (Medium)</option>
                        <option value="hard">ยาก (Hard)</option>
                    </select>
                    
                    <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-md transition duration-200">เริ่มเกม</button>
                    <p class="text-[10px] text-gray-500 mt-4 uppercase tracking-tighter">* เคลียร์บล็อกทั้งหมดเพื่อเรียกบอสออกมา</p>
                </div>
            </div>

            <!-- UI Overlay: Message Box -->
            <div id="messageBox" class="absolute inset-0 hidden items-center justify-center bg-black bg-opacity-80 rounded-lg z-20 p-4">
                <div class="bg-gray-800 p-6 md:p-8 rounded-lg shadow-2xl text-center w-full max-w-sm border border-gray-600">
                    <h2 id="messageTitle" class="text-2xl md:text-3xl font-bold mb-2 text-white"></h2>
                    <p id="messageText" class="text-lg mb-6 text-gray-300"></p>
                    <button id="restartButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-md transition duration-200">ลุยเลเวลถัดไป</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:flex md:justify-between items-center w-full max-w-3xl px-4 py-2 bg-gray-800 rounded-lg border border-gray-700 gap-2">
            <div class="text-[10px] md:text-sm uppercase tracking-widest text-gray-400">Name: <span id="playerNameDisplay" class="text-blue-400 font-bold">-</span></div>
            <div class="text-[10px] md:text-sm uppercase tracking-widest text-gray-400 text-right md:text-left">Score: <span id="scoreDisplay" class="text-white font-bold">0</span></div>
            <div class="text-[10px] md:text-sm uppercase tracking-widest text-gray-400">Lives: <span id="livesDisplay" class="text-red-400 font-bold">3</span></div>
            <div id="bossShieldContainer" class="text-[10px] md:text-sm uppercase tracking-widest text-gray-400 hidden text-right md:text-left">Boss Shield: <span id="bossShieldDisplay" class="text-yellow-400 font-bold">3/3</span></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const startModal = document.getElementById('startModal');
        const messageBox = document.getElementById('messageBox');
        
        let gameActive = false;
        let animationId = null;
        let score = 0;
        let lives = 3;
        let level = 1;
        let playerName = "";
        let paddleX;
        const paddleWidth = 140;
        const paddleHeight = 15;
        const ballRadius = 8;
        
        let balls = [];
        let bricks = [];
        let difficulty = 'medium';
        
        let bossMode = false;
        let boss = null;
        let bossProjectiles = [];
        let bossLives = 3;
        let isWinState = false;

        // Cheat Code Logic
        let cheatInput = "";
        window.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            // Only capture number keys
            if (e.key >= '0' && e.key <= '9') {
                cheatInput += e.key;
                if (cheatInput.includes("1234")) {
                    cheatInput = "";
                    if (bossMode && boss) {
                        boss.hp = 0;
                        console.log("Cheat Activated: Boss Defeated");
                    } else if (!bossMode) {
                        // Kill all bricks if not in boss mode
                        bricks.forEach(col => col.forEach(b => b.status = 0));
                        console.log("Cheat Activated: Bricks Cleared");
                    }
                }
                // Keep only last 4 chars
                if (cheatInput.length > 4) cheatInput = cheatInput.slice(-4);
            }
        });

        const config = {
            easy: { speed: 4, rows: 3, cols: 6, bossHp: 5 },
            medium: { speed: 6, rows: 4, cols: 8, bossHp: 10 },
            hard: { speed: 8, rows: 5, cols: 10, bossHp: 15 }
        };

        function initBricks() {
            const { rows, cols } = config[difficulty];
            const padding = 10;
            const offsetTop = 80;
            const offsetLeft = 35;
            const bWidth = (canvas.width - (offsetLeft * 2) - (padding * (cols-1))) / cols;
            const bHeight = 25;

            bricks = [];
            for(let c=0; c<cols; c++) {
                bricks[c] = [];
                for(let r=0; r<rows; r++) {
                    bricks[c][r] = { x: 0, y: 0, status: 1, w: bWidth, h: bHeight };
                }
            }
        }

        function spawnBoss() {
            bossMode = true;
            const baseHp = config[difficulty].bossHp;
            const currentMaxHp = baseHp + (level * 10); 
            
            boss = {
                x: canvas.width / 2 - 75,
                y: 60,
                w: 150,
                h: 50,
                hp: currentMaxHp,
                maxHp: currentMaxHp,
                dx: 3 + (level * 0.8),
                lastShot: 0
            };
            bossProjectiles = [];
            bossLives = 3; 
            document.getElementById('bossShieldContainer').classList.remove('hidden');
            updateUI();
        }

        function resetGame(fullReset = true) {
            if (animationId) cancelAnimationFrame(animationId);
            
            if(fullReset) {
                level = 1;
                score = 0;
                playerName = document.getElementById('nameInput').value || "Player";
            } else {
                level++;
            }
            
            difficulty = document.getElementById('difficultySelect').value;
            const settings = config[difficulty];
            lives = 3;
            bossMode = false;
            boss = null;
            bossProjectiles = [];
            isWinState = false;
            cheatInput = "";
            
            document.getElementById('bossShieldContainer').classList.add('hidden');
            document.getElementById('levelIndicator').innerText = `LEVEL ${level}`;
            document.getElementById('playerNameDisplay').innerText = playerName;
            
            paddleX = (canvas.width - paddleWidth) / 2;
            balls = [{
                x: canvas.width / 2,
                y: canvas.height - 60,
                dx: (settings.speed + (level * 0.3)) * (Math.random() > 0.5 ? 1 : -1),
                dy: -(settings.speed + (level * 0.3))
            }];
            initBricks();
            updateUI();
            gameActive = true;
        }

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = score;
            document.getElementById('livesDisplay').innerText = lives;
            document.getElementById('bossShieldDisplay').innerText = bossLives + "/3";
        }

        function handleInput(clientX) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            paddleX = (clientX - rect.left) * scaleX - paddleWidth / 2;
            if(paddleX < 0) paddleX = 0;
            if(paddleX + paddleWidth > canvas.width) paddleX = canvas.width - paddleWidth;
        }

        canvas.addEventListener('mousemove', (e) => handleInput(e.clientX));
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleInput(e.touches[0].clientX);
        }, { passive: false });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            handleInput(e.touches[0].clientX);
        }, { passive: false });

        function draw() {
            if(!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if(!bossMode) {
                let bricksLeft = 0;
                bricks.forEach((col, c) => {
                    col.forEach((b, r) => {
                        if(b.status === 1) {
                            bricksLeft++;
                            const padding = 10;
                            const offsetTop = 80;
                            const offsetLeft = 35;
                            b.x = (c * (b.w + padding)) + offsetLeft;
                            b.y = (r * (b.h + padding)) + offsetTop;
                            ctx.beginPath();
                            ctx.roundRect(b.x, b.y, b.w, b.h, 4);
                            ctx.fillStyle = `hsl(${200 + (r*25)}, 70%, 50%)`;
                            ctx.fill();
                            ctx.closePath();
                        }
                    });
                });
                if(bricksLeft === 0) spawnBoss();
            } else if(boss) {
                ctx.beginPath();
                ctx.roundRect(boss.x, boss.y, boss.w, boss.h, 10);
                ctx.fillStyle = "#ef4444";
                ctx.fill();
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.closePath();

                const hbW = 300;
                ctx.fillStyle = "#333";
                ctx.fillRect(canvas.width/2 - hbW/2, 25, hbW, 20);
                ctx.fillStyle = "#f87171";
                ctx.fillRect(canvas.width/2 - hbW/2, 25, (Math.max(0, boss.hp) / boss.maxHp) * hbW, 20);

                boss.x += boss.dx;
                if(boss.x < 0 || boss.x + boss.w > canvas.width) boss.dx = -boss.dx;

                const now = Date.now();
                if(now - boss.lastShot > (1800 - (level * 100))) {
                    bossProjectiles.push({ x: boss.x + boss.w/2, y: boss.y + boss.h, dy: 5 + (level * 0.4) });
                    boss.lastShot = now;
                }

                bossProjectiles.forEach((p, pi) => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 10, 0, Math.PI*2);
                    ctx.fillStyle = "#fbbf24";
                    ctx.fill();
                    ctx.closePath();
                    p.y += p.dy;

                    if(p.y > canvas.height - paddleHeight - 25 && p.x > paddleX && p.x < paddleX + paddleWidth) {
                        bossProjectiles.splice(pi, 1);
                        bossLives--;
                        updateUI();
                        if(bossLives <= 0) endGame("คุณพ่ายแพ้!", "เกราะป้องกันพังทลายแล้ว!", false);
                    }
                    if(p.y > canvas.height) bossProjectiles.splice(pi, 1);
                });

                // Check if boss died (via cheat or ball)
                if (boss.hp <= 0) {
                    boss = null;
                    endGame("บอสพ่ายแพ้!", "บล็อกกำลังฟื้นตัว... เตรียมพร้อมเลเวลถัดไป", true);
                }
            }

            ctx.beginPath();
            ctx.roundRect(paddleX, canvas.height - paddleHeight - 20, paddleWidth, paddleHeight, 8);
            ctx.fillStyle = "#3b82f6";
            ctx.fill();
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#3b82f6";
            ctx.closePath();
            ctx.shadowBlur = 0;

            balls.forEach((ball, bi) => {
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI*2);
                ctx.fillStyle = "#FFF";
                ctx.fill();
                ctx.closePath();

                if(ball.x + ball.dx > canvas.width - ballRadius || ball.x + ball.dx < ballRadius) ball.dx = -ball.dx;
                if(ball.y + ball.dy < ballRadius) ball.dy = -ball.dy;

                if(ball.y + ball.dy > canvas.height - paddleHeight - 35) {
                    if(ball.x > paddleX && ball.x < paddleX + paddleWidth) {
                        ball.dy = -Math.abs(ball.dy);
                        let hitPoint = (ball.x - (paddleX + paddleWidth/2)) / (paddleWidth/2);
                        ball.dx = hitPoint * (config[difficulty].speed + (level * 0.4));
                    } else if (ball.y > canvas.height) {
                        lives--;
                        updateUI();
                        if(lives <= 0) endGame("GAME OVER", "เลเวลที่คุณไปถึง: " + level, false);
                        else {
                            ball.x = canvas.width / 2; 
                            ball.y = canvas.height - 60;
                            ball.dy = -(config[difficulty].speed + (level * 0.4));
                        }
                    }
                }

                if(!bossMode) {
                    bricks.forEach(col => {
                        col.forEach(b => {
                            if(b.status === 1 && ball.x > b.x && ball.x < b.x + b.w && ball.y > b.y && ball.y < b.y + b.h) {
                                ball.dy = -ball.dy; b.status = 0; score += 10; updateUI();
                            }
                        });
                    });
                } else if(boss) {
                    if(ball.x > boss.x && ball.x < boss.x + boss.w && ball.y > boss.y && ball.y < boss.y + boss.h) {
                        ball.dy = -ball.dy;
                        boss.hp -= 1;
                        score += 50;
                        updateUI();
                    }
                }
                ball.x += ball.dx;
                ball.y += ball.dy;
            });

            animationId = requestAnimationFrame(draw);
        }

        function endGame(title, text, win) {
            gameActive = false;
            if (animationId) cancelAnimationFrame(animationId);
            
            isWinState = win;
            document.getElementById('messageTitle').innerText = title;
            document.getElementById('messageText').innerText = `${text} | คะแนนรวม: ${score}`;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
            
            if(win) {
                restartButton.innerText = "ลุยเลเวล " + (level + 1);
                restartButton.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-md transition duration-200";
            } else {
                restartButton.innerText = "เริ่มใหม่ทั้งหมด";
                restartButton.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-md transition duration-200";
            }
        }

        startButton.onclick = () => {
            startModal.classList.add('hidden');
            resetGame(true);
            draw();
        };

        restartButton.onclick = () => {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
            if(isWinState) {
                resetGame(false); 
                draw();
            } else {
                startModal.classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
